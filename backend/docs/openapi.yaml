openapi: 3.1.0
info:
  title: Quantum X Trading API
  description: |
    REST API for the Quantum X quantitative trading system.

    ## Overview
    This API provides endpoints for:
    - Portfolio management and position tracking
    - Strategy monitoring and control
    - Real-time market data
    - Risk management and monitoring

    ## Authentication
    MVP version uses no authentication. Production will require API keys.

    ## Rate Limits
    - 100 requests per minute (MVP)
    - 1000 requests per minute (Production)
  version: 0.1.0
  contact:
    name: Quantum X Team
    email: support@quantumx.dev
  license:
    name: MIT

servers:
  - url: http://localhost:3001
    description: Local development
  - url: http://backend:3001
    description: Docker container

tags:
  - name: Health
    description: System health endpoints
  - name: Portfolio
    description: Portfolio and position management
  - name: Accounts
    description: Account mode management and linking
  - name: Strategies
    description: Strategy monitoring and control
  - name: Market
    description: Market data endpoints
  - name: Risk
    description: Risk management and monitoring

paths:
  /api/health:
    get:
      tags: [Health]
      summary: Health check
      description: Returns service health status
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/portfolio/account:
    get:
      tags: [Portfolio]
      summary: Get account state
      description: Returns full account state including equity, margin, and P&L
      operationId: getAccountState
      responses:
        '200':
          description: Account state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountState'
        '404':
          description: No active account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Account mode mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/portfolio/positions:
    get:
      tags: [Portfolio]
      summary: Get open positions
      description: Returns all currently open positions
      operationId: getPositions
      responses:
        '200':
          description: List of positions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Position'
        '404':
          description: No active account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Account mode mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/portfolio/stats:
    get:
      tags: [Portfolio]
      summary: Get portfolio statistics
      description: Returns aggregated portfolio statistics
      operationId: getPortfolioStats
      responses:
        '200':
          description: Portfolio statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioStats'
        '404':
          description: No active account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Account mode mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/portfolio/positions/close:
    post:
      tags: [Portfolio]
      summary: Close position
      description: Close an open position by symbol
      operationId: closePosition
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [symbol]
              properties:
                symbol:
                  type: string
                  example: BTC/USDT
      responses:
        '200':
          description: Position closed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  symbol:
                    type: string
        '409':
          description: Account mode mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/orders:
    get:
      tags: [Portfolio]
      summary: List orders
      description: Returns open and historical orders for the active simulated account
      operationId: listOrders
      parameters:
        - name: symbol
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of orders
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Order'
        '409':
          description: Account mode mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags: [Portfolio]
      summary: Submit order
      description: Submit an order for the active simulated account
      operationId: submitOrder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderRequest'
      responses:
        '201':
          description: Order created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '409':
          description: Account mode mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/orders/{id}/cancel:
    post:
      tags: [Portfolio]
      summary: Cancel order
      description: Cancel an order in the active simulated account
      operationId: cancelOrder
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Cancel successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Account mode mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/trades:
    get:
      tags: [Portfolio]
      summary: List trades
      description: Returns trades for the active simulated account
      operationId: listTrades
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
      responses:
        '200':
          description: Trade list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Trade'
        '409':
          description: Account mode mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/accounts:
    get:
      tags: [Accounts]
      summary: List accounts
      description: Returns all accounts and active account id
      operationId: listAccounts
      responses:
        '200':
          description: Accounts
          content:
            application/json:
              schema:
                type: object
                properties:
                  accounts:
                    type: array
                    items:
                      $ref: '#/components/schemas/AccountRecord'
                  activeAccountId:
                    type: string
                    nullable: true

  /api/accounts/active:
    get:
      tags: [Accounts]
      summary: Get active account
      operationId: getActiveAccount
      responses:
        '200':
          description: Active account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountRecord'
        '404':
          description: No active account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/accounts/simulated:
    post:
      tags: [Accounts]
      summary: Create simulated account
      operationId: createSimulatedAccount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SimulatedAccountInput'
      responses:
        '201':
          description: Created simulated account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountRecord'

  /api/accounts/real:
    post:
      tags: [Accounts]
      summary: Link real account
      operationId: linkRealAccount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RealAccountInput'
      responses:
        '201':
          description: Linked real account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountRecord'

  /api/accounts/{id}/activate:
    post:
      tags: [Accounts]
      summary: Activate account
      operationId: activateAccount
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Activated account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountRecord'
        '404':
          description: Account not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/strategies:
    get:
      tags: [Strategies]
      summary: List strategies
      description: Returns all configured trading strategies
      operationId: listStrategies
      responses:
        '200':
          description: List of strategies
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Strategy'

  /api/strategies/{id}:
    get:
      tags: [Strategies]
      summary: Get strategy
      description: Returns a single strategy by ID
      operationId: getStrategy
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Strategy details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Strategy'
        '404':
          description: Strategy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/strategies/{id}/signals:
    get:
      tags: [Strategies]
      summary: Get strategy signals
      description: Returns recent trading signals generated by the strategy
      operationId: getStrategySignals
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of signals
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Signal'

  /api/strategies/{id}/status:
    put:
      tags: [Strategies]
      summary: Update strategy status
      description: Change strategy status (active, paused, stopped)
      operationId: updateStrategyStatus
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [active, paused, stopped]
      responses:
        '200':
          description: Strategy updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Strategy'
        '404':
          description: Strategy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/market/klines:
    get:
      tags: [Market]
      summary: Get OHLCV data
      description: Returns candlestick/kline data for a symbol
      operationId: getKlines
      parameters:
        - name: symbol
          in: query
          schema:
            type: string
            default: BTCUSDT
        - name: interval
          in: query
          schema:
            type: string
            enum: [1m, 3m, 5m, 15m, 30m, 1h, 2h, 4h, 6h, 8h, 12h, 1d, 3d, 1w, 1M]
            default: 1h
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            maximum: 1000
      responses:
        '200':
          description: OHLCV bars
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OHLCVBar'
        '500':
          description: Data fetch failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/market/ticker:
    get:
      tags: [Market]
      summary: Get ticker
      description: Returns best bid/ask and last price for a symbol
      operationId: getTicker
      parameters:
        - name: symbol
          in: query
          schema:
            type: string
            default: BTCUSDT
      responses:
        '200':
          description: Ticker data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ticker'
        '500':
          description: Data fetch failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/market/tickers:
    get:
      tags: [Market]
      summary: Get all tickers
      description: Returns tickers for all watched symbols
      operationId: getTickers
      responses:
        '200':
          description: List of tickers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TickerSummary'

  /api/market/trades:
    get:
      tags: [Market]
      summary: Get recent trades
      description: Returns recent trade executions for a symbol
      operationId: getTrades
      parameters:
        - name: symbol
          in: query
          schema:
            type: string
            default: BTC/USDT
      responses:
        '200':
          description: List of trades
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Trade'

  /api/risk/metrics:
    get:
      tags: [Risk]
      summary: Get risk metrics
      description: Returns current risk metrics and alerts
      operationId: getRiskMetrics
      responses:
        '200':
          description: Risk metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskMetrics'
        '409':
          description: Account mode mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/risk/events:
    get:
      tags: [Risk]
      summary: Get risk events
      description: Returns recent risk events and alerts
      operationId: getRiskEvents
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
        - name: level
          in: query
          schema:
            type: string
            enum: [info, warning, critical]
      responses:
        '200':
          description: List of risk events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RiskEvent'
        '409':
          description: Account mode mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/risk/limits:
    get:
      tags: [Risk]
      summary: Get risk limits
      description: Returns configured risk limits for active account
      operationId: getRiskLimits
      responses:
        '200':
          description: Risk limits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskLimits'
        '409':
          description: Account mode mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        timestamp:
          type: integer
          format: int64

    AccountState:
      type: object
      properties:
        totalEquity:
          type: number
          description: Total account value
        equity:
          type: number
          description: Alias for totalEquity
        cash:
          type: number
          description: Available cash
        margin:
          type: number
          description: Margin used
        marginLevel:
          type: number
          description: Margin level ratio
        unrealizedPnl:
          type: number
        realizedPnl:
          type: number
        dailyPnl:
          type: number
        weeklyPnl:
          type: number
        peakEquity:
          type: number
        drawdown:
          type: number
        drawdownPct:
          type: number
        openPositions:
          type: integer
        positions:
          type: array
          items:
            $ref: '#/components/schemas/Position'
        timestamp:
          type: integer
          format: int64

    Position:
      type: object
      properties:
        symbol:
          type: string
          example: BTC/USDT
        side:
          type: string
          enum: [long, short]
        quantity:
          type: number
        entryPrice:
          type: number
        markPrice:
          type: number
        currentPrice:
          type: number
        unrealizedPnl:
          type: number
        unrealizedPnlPct:
          type: number
        leverage:
          type: number
        marginUsed:
          type: number
        stopLoss:
          type: number
          nullable: true
        takeProfit:
          type: number
          nullable: true

    PortfolioStats:
      type: object
      properties:
        totalValue:
          type: number
        totalPnl:
          type: number
        totalPnlPercent:
          type: number
        dayPnl:
          type: number
        dayPnlPercent:
          type: number
        cashBalance:
          type: number

    AccountRecord:
      type: object
      required: [id, name, mode, status, createdAt, updatedAt]
      properties:
        id:
          type: string
        name:
          type: string
        mode:
          type: string
          enum: [simulated, real]
        provider:
          type: string
          enum: [binance, okx, bybit]
        status:
          type: string
          enum: [active, inactive, pending, error]
        createdAt:
          type: string
        updatedAt:
          type: string
        lastConnectedAt:
          type: string
          nullable: true
        permissions:
          type: array
          items:
            type: string
        metadata:
          type: object
          additionalProperties: true

    SimulatedAccountInput:
      type: object
      required: [name]
      properties:
        name:
          type: string
        initialCapital:
          type: number
        setActive:
          type: boolean

    RealAccountInput:
      type: object
      required: [name, provider, credentials]
      properties:
        name:
          type: string
        provider:
          type: string
          enum: [binance, okx, bybit]
        credentials:
          type: object
          required: [apiKey, apiSecret]
          properties:
            apiKey:
              type: string
            apiSecret:
              type: string
            passphrase:
              type: string
        permissions:
          type: array
          items:
            type: string
        setActive:
          type: boolean

    OrderRequest:
      type: object
      required: [symbol, side, type, quantity]
      properties:
        symbol:
          type: string
        side:
          type: string
          enum: [buy, sell]
        type:
          type: string
          enum: [market, limit, stop, stop_limit]
        quantity:
          type: number
        price:
          type: number
        stopPrice:
          type: number
        timeInForce:
          type: string
          enum: [GTC, IOC, FOK]
        reduceOnly:
          type: boolean
        postOnly:
          type: boolean
        strategyId:
          type: string
        clientOrderId:
          type: string
        accountId:
          type: string
        accountMode:
          type: string
          enum: [simulated, real]

    Error:
      type: object
      properties:
        error:
          type: string

    Strategy:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [active, paused, stopped]
        type:
          type: string
        symbols:
          type: array
          items:
            type: string
        pnl:
          type: number
        pnlPercent:
          type: number
        sharpeRatio:
          type: number
        maxDrawdown:
          type: number
        winRate:
          type: number
        tradesCount:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Signal:
      type: object
      properties:
        strategyId:
          type: string
        symbol:
          type: string
        type:
          type: string
        direction:
          type: string
          enum: [long, short, neutral]
        strength:
          type: number
          minimum: 0
          maximum: 1
        confidence:
          type: number
          minimum: 0
          maximum: 1
        timestamp:
          type: integer
          format: int64

    OHLCVBar:
      type: object
      properties:
        timestamp:
          type: integer
          format: int64
          description: Unix timestamp in milliseconds
        open:
          type: number
        high:
          type: number
        low:
          type: number
        close:
          type: number
        volume:
          type: number
        symbol:
          type: string
        exchange:
          type: string
        interval:
          type: string

    Ticker:
      type: object
      properties:
        timestamp:
          type: integer
          format: int64
        symbol:
          type: string
        exchange:
          type: string
        bid:
          type: number
        ask:
          type: number
        bidSize:
          type: number
        askSize:
          type: number
        last:
          type: number
        lastSize:
          type: number

    TickerSummary:
      type: object
      properties:
        symbol:
          type: string
        bid:
          type: number
        ask:
          type: number
        last:
          type: number
        volume24h:
          type: number
        change24h:
          type: number
        changePct24h:
          type: number
        timestamp:
          type: integer
          format: int64

    Trade:
      type: object
      properties:
        id:
          type: string
        orderId:
          type: string
        symbol:
          type: string
        side:
          type: string
          enum: [buy, sell]
        price:
          type: number
        quantity:
          type: number
        commission:
          type: number
        timestamp:
          type: integer
          format: int64

    RiskMetrics:
      type: object
      properties:
        currentDrawdown:
          type: number
        maxDrawdown:
          type: number
        dailyVaR:
          type: number
        sharpeRatio:
          type: number
        marginLevel:
          type: number
        riskEvents:
          type: array
          items:
            $ref: '#/components/schemas/RiskEvent'

    RiskEvent:
      type: object
      properties:
        timestamp:
          type: integer
          format: int64
        type:
          type: string
          enum: [check, breach, action]
        level:
          type: string
          enum: [info, warning, critical]
        category:
          type: string
          enum: [account, strategy, trade, system]
        message:
          type: string
        data:
          type: object

    Error:
      type: object
      properties:
        error:
          type: string
